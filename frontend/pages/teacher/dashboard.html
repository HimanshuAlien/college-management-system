<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - College MS</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <a href="/" class="logo">College Alien</a>
            <ul class="nav-menu">
                <li><a href="dashboard.html" class="active">Dashboard</a></li>
                <li><a href="attendance.html">Attendance</a></li>
                <li><a href="grading.html">Grading</a></li>
                <li><a href="messages.html">Messages</a></li>
                <li class="keep"><button id="theme-toggle" class="theme-toggle">üåô</button></li>
                <li class="keep"><button onclick="logout()" class="btn btn-danger">Logout</button></li>
            </ul>
        </div>
    </nav>

    <main class="container main-content">
        <div class="dashboard-header">
            <h1>Welcome, <span id="user-name">Teacher</span>!</h1>
            <p class="dashboard-greeting">Manage your classes and track student progress</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-value" id="total-subjects">0</div>
                <div class="stat-label">Subjects Teaching</div>
            </div>

            <div class="stat-card success">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="total-students">0</div>
                <div class="stat-label">Total Students</div>
            </div>

            <div class="stat-card warning">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="today-attendance">0</div>
                <div class="stat-label">Today's Attendance</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="attendance.html" class="quick-action">
                <div class="quick-action-icon">üìä</div>
                <div class="quick-action-title">Mark Attendance</div>
                <div class="quick-action-desc">Record student attendance</div>
            </a>

            <a href="grading.html" class="quick-action">
                <div class="quick-action-icon">üìã</div>
                <div class="quick-action-title">Grade Assignments</div>
                <div class="quick-action-desc">Review and grade submissions</div>
            </a>

            <a href="#" onclick="createAssignment()" class="quick-action">
                <div class="quick-action-icon">üìù</div>
                <div class="quick-action-title">Create Assignment</div>
                <div class="quick-action-desc">Add new assignments</div>
            </a>

            <a href="messages.html" class="quick-action">
                <div class="quick-action-icon">üí¨</div>
                <div class="quick-action-title">Messages</div>
                <div class="quick-action-desc">Chat with students</div>
            </a>
        </div>

        <div class="grid grid-cols-2">
            <!-- My Subjects -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">My Subjects</h3>
                    <p class="card-subtitle">Classes you're teaching</p>
                </div>
                <div id="teacher-subjects">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- Recent Assignments -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Assignments</h3>
                    <p class="card-subtitle">Latest assignments created</p>
                </div>
                <div id="recent-assignments">
                    <div class="loading"></div>
                </div>
            </div>



            <!-- Create Assignment Modal -->
            <div id="assignment-modal" class="modal hidden">
                <div class="modal-content">
                    <h3>Create New Assignment</h3>
                    <form id="assignment-form">
                        <div class="form-group">
                            <label class="form-label">Subject</label>
                            <select name="subjectId" id="assignment-subject" class="form-select" required>
                                <option value="">Select Subject</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Assignment Title</label>
                            <input type="text" name="title" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-textarea" rows="3" required></textarea>
                        </div>

                        <div class="grid grid-cols-2">
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="datetime-local" name="dueDate" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Maximum Marks</label>
                                <input type="number" name="maxMarks" class="form-input" min="1" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Instructions (Optional)</label>
                            <textarea name="instructions" class="form-textarea" rows="2"></textarea>
                        </div>

                        <div class="flex gap-2 justify-end">
                            <button type="button" onclick="closeAssignmentModal()"
                                class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Assignment</button>
                        </div>
                    </form>
                </div>
            </div>
    </main>

    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/dashboard.js"></script>
    <script>
        function createAssignment() {
            document.getElementById('assignment-modal').style.display = 'flex';
            loadSubjectsForAssignment();
        }

        function closeAssignmentModal() {
            document.getElementById('assignment-modal').style.display = 'none';
            document.getElementById('assignment-form').reset();
        }

        async function loadSubjectsForAssignment() {
            try {
                const data = await app.apiCall('/teacher/subjects');
                const select = document.getElementById('assignment-subject');
                select.innerHTML = '<option value="">Select Subject</option>';

                data.subjects.forEach(subject => {
                    select.innerHTML += `
                    <option value="${subject._id}">
                        ${subject.name} - ${subject.class.name}
                    </option>
                `;
                });
            } catch (error) {
                console.error('Failed to load subjects:', error);
            }
        }

        // ‚úÖ DELETE ASSIGNMENT FUNCTION
        async function deleteAssignment(assignmentId) {
            if (!confirm('Are you sure you want to delete this assignment? This action cannot be undone.')) {
                return;
            }

            try {
                await app.apiCall(`/teacher/assignments/${assignmentId}`, {
                    method: 'DELETE'
                });

                // Remove from DOM
                const assignmentElement = document.querySelector(`[data-assignment-id="${assignmentId}"]`);
                if (assignmentElement) {
                    assignmentElement.style.opacity = '0.5';
                    setTimeout(() => assignmentElement.remove(), 200);
                }

                showNotification('Assignment deleted successfully!', 'success');

                // Refresh assignments display
                loadRecentAssignments();
            } catch (error) {
                console.error('Failed to delete assignment:', error);
                showNotification('Failed to delete assignment: ' + error.message, 'error');
            }
        }

        // ‚úÖ LOAD AND DISPLAY ASSIGNMENTS WITH DELETE BUTTONS
        async function loadRecentAssignments() {
            try {
                const response = await app.apiCall('/teacher/assignments');
                displayAssignmentsWithDelete(response.assignments || []);
            } catch (error) {
                console.error('Failed to load assignments:', error);
                document.getElementById('recent-assignments').innerHTML = '<p>Error loading assignments.</p>';
            }
        }

        // ‚úÖ DISPLAY ASSIGNMENTS WITH DELETE BUTTONS
        function displayAssignmentsWithDelete(assignments) {
            const container = document.getElementById('recent-assignments');

            if (!assignments || assignments.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No assignments created yet.</p>';
                return;
            }

            // Create HTML with delete buttons
            let html = '';
            assignments.forEach(assignment => {
                html += `
                    <div data-assignment-id="${assignment._id}" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: #f8f9fa; margin: 5px 0; border-radius: 6px;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 4px 0; font-size: 14px; color: #333;">üìù ${assignment.title || 'Untitled'}</h4>
                            <p style="margin: 0; color: #666; font-size: 12px;">
                                Due: ${new Date(assignment.dueDate).toLocaleDateString()} ‚Ä¢ 
                                Max Marks: ${assignment.maxMarks || 0} ‚Ä¢ 
                                Subject: ${assignment.subject?.name || 'N/A'}
                            </p>
                        </div>
                        <button onclick="deleteAssignment('${assignment._id}')" 
                                style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 10px; transition: background 0.2s;"
                                onmouseover="this.style.background='#c82333'" 
                                onmouseout="this.style.background='#dc3545'">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        document.getElementById('assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const assignmentData = Object.fromEntries(formData.entries());

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            try {
                submitBtn.innerHTML = '<div class="loading"></div> Creating...';
                submitBtn.disabled = true;

                await app.apiCall('/teacher/assignments', {
                    method: 'POST',
                    body: JSON.stringify(assignmentData)
                });

                showNotification('Assignment created successfully!', 'success');
                closeAssignmentModal();

                // ‚úÖ Refresh assignments with delete buttons
                loadRecentAssignments();
            } catch (error) {
                console.error('Failed to create assignment:', error);
                showNotification('Failed to create assignment: ' + error.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // ‚úÖ LOAD ASSIGNMENTS WHEN PAGE LOADS
        document.addEventListener('DOMContentLoaded', function () {
            // Load assignments with delete buttons when page loads
            setTimeout(() => {
                loadRecentAssignments();
            }, 1000); // Wait 1 second for other scripts to load
        });
        function updateAssignmentDarkMode() {
            const darkModeOn = document.body.classList.contains('dark-mode');

            // Select all assignment items (divs with data-assignment-id)
            document.querySelectorAll("[data-assignment-id]").forEach(item => {
                if (darkModeOn) {
                    // When dark-mode class is present, show LIGHT colors
                    item.style.background = "#f8f9fa";
                    item.style.color = "#222";

                    // Update h4 and p inside
                    item.querySelectorAll("h4").forEach(el => {
                        el.style.color = "#333";
                    });
                    item.querySelectorAll("p").forEach(el => {
                        el.style.color = "#666";
                    });

                    // Update button color
                    item.querySelectorAll("button").forEach(btn => {
                        btn.style.background = "#dc3545";
                        btn.style.color = "#fff";
                    });
                } else {
                    // When dark-mode class is NOT present, show DARK colors
                    item.style.background = "#23272a";
                    item.style.color = "#eee";

                    item.querySelectorAll("h4, p").forEach(el => {
                        el.style.color = "#eee";
                    });

                    item.querySelectorAll("button").forEach(btn => {
                        btn.style.background = "#ff7675";
                        btn.style.color = "#222";
                    });
                }
            });
        }

        // Hook into your theme toggle button
        document.getElementById("theme-toggle").addEventListener("click", function () {
            document.body.classList.toggle("dark-mode");
            updateAssignmentDarkMode();
        });

        // Call on page load
        document.addEventListener("DOMContentLoaded", function () {
            updateAssignmentDarkMode();
        });

        // ‚úÖ Force dark mode on every load
        document.addEventListener("DOMContentLoaded", function () {
            document.body.classList.remove("dark-mode");
            updateAssignmentDarkMode();
        });



    </script>

</body>

</html>